---
title: "Chapter 2 notes"
author: "Addison"
date: "4/17/2022"
output: html_document
---

# Chapter 2 Time series graphics [[textbook link]](https://otexts.com/fpp3/graphics.html)

Quote: "Graphs enable many features of the data to be visualised, including patterns, unusual observations, changes over time, and relationships between variables"

Load required packages.
```{r, library-loading, results='hide', warning=FALSE, message=FALSE}
library(fpp3)
library(readr)
```
## 2.1 `tsibble` objects [[section link]](https://otexts.com/fpp3/tsibbles.html)

Think of a time series as a list of numbers (measurements) along with info about the times they were recorded.

### The index variable [[subsection link]](https://otexts.com/fpp3/tsibbles.html#the-index-variable)

```{r, first-tsibble-example}
# tsibble is used for temporal data
y <- tsibble(
  Year = 2015:2019,
  Observation = c(123, 39, 78, 52, 110),
  index = Year
)
y
```

```{r, monthly-data}
# Some example monthly observational data
mon <- c("2019 Jan", "2019 Feb", "2019 Mar","2019 Apr", "2019 May")
obs <- c(50, 23, 34, 30, 25)
z <- data.frame(Month = mon, Observations = obs)

# Creating a tsibble from a data frame of temporal data
z %>%
  # yearmonth, below, is an example of a time class function
  # other examples in Freq/Func table in section 2.1
  # from annual down to sub-daily.
  mutate(Month = yearmonth(Month)) %>%
  as_tsibble(index=Month)
```

### The key variables [[subsection link]](https://otexts.com/fpp3/tsibbles.html#the-key-variables)

```{r, multiple-time-series-in-single-tsibble}
olympic_running

# Show the categories of a variable
olympic_running %>% distinct(Sex)

# Show the distinct combinations of two variables.
# Section 2.1 states these two series uniquely identify
# each record.
olympic_running %>% distinct(Sex, Length)

```

### Working with `tsibble` objects [[subsection link]](https://otexts.com/fpp3/tsibbles.html#working-with-tsibble-objects)

Working with dataset `PBS`. Medicare Australia prescription data from July 1991 to June 2008. These are classified according to various concession types, and Anatomical Therapeutic Chemical (ATC) indexes.

```{r, common-dplyr-functions}
PBS

# We're interested in the Cost time series
PBS %>% 
  filter(ATC2 == "A10")

# We're interested in a few select columns
PBS %>% 
  filter(ATC2 == "A10") %>% 
  select(Month, Concession, Type, Cost)

# We want to see the total cost per month
# regardless of Concession or Type
PBS %>% 
  filter(ATC2 == "A10") %>% 
  select(Month, Concession, Type, Cost) %>% 
  summarise(TotalC = sum(Cost))

# change the units from dollars to millions of dollars
# and save result to new variable.
PBS %>% 
  filter(ATC2 == "A10") %>% 
  select(Month, Concession, Type, Cost) %>% 
  summarise(TotalC = sum(Cost)) %>% 
  mutate(Cost = TotalC / 1e6) -> a10

a10
```

### Read a csv file and conver to a tsibble [[subsection link]](https://otexts.com/fpp3/tsibbles.html#read-a-csv-file-and-convert-to-a-tsibble)

Commonly one reads in csv data, and then identifies the index and key variables.

```{r, read-in-csv}
prison <- readr::read_csv("remote_data/prison_population.csv")

prison <- prison %>% 
  mutate(Quarter = yearquarter(Date)) %>%
  # select everything except the Date column
  select(-Date) %>% 
  as_tsibble(
    key = c(State, Gender, Legal, Indigenous),
    index = Quarter
  )

prison
```

Book states: "for a tsibble to be valid, it requires a unique index for each combination of keys." Therefore, we get an error with the following:
```{r, unique-index-test}
tryCatch(
  expr = data.frame(
    Year = c(1990,1990,1990,1990),
    key1 = c("3","3","3","3"),
    key2 = c("4","5","5","6"),
    m  = c(1,2,3,4)
  ) %>% as_tsibble(index = Year, key = c(key1, key2)),
  error = function(x) {
    x
  }
)
```

```{r}
print("tryCatch worked as expected: printed error and execution continued.")
```

### The seasonal period [[subsection link]](https://otexts.com/fpp3/tsibbles.html#the-seasonal-period)

Contains a useful table containing numbers of time units in different periods.
